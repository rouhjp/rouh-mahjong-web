# 麻雀オンラインアプリ - 開発仕様書

## プロジェクト概要

WebSocketを使用したリアルタイム4人対戦麻雀アプリです。

### 技術スタック

**バックエンド:**
- Node.js + TypeScript
- Express (REST API)
- Socket.io (WebSocket通信)
- UUID (ユーザー識別)

**フロントエンド:**
- React + TypeScript
- Vite (ビルドツール)
- Socket.io-client (リアルタイム通信)

## プロジェクト構成

```
demo-app/
├── server/
│   ├── src/
│   │   ├── index.ts              # メインサーバーファイル
│   │   ├── managers/
│   │   │   └── RoomManager.ts    # ルーム管理クラス
│   │   └── types/
│   │       └── index.ts          # 型定義
│   ├── package.json
│   └── tsconfig.json
├── client/
│   ├── src/
│   │   ├── App.tsx               # メインアプリ
│   │   ├── App.css               # スタイル
│   │   ├── hooks/
│   │   │   └── useSocket.ts      # Socket.io カスタムフック
│   │   └── types/
│   │       └── index.ts          # 型定義
│   ├── package.json
│   └── vite.config.ts
└── CLAUDE.md                     # この仕様書
```

## 起動方法

**サーバー起動:**
```bash
cd server
npm run dev  # http://localhost:3000
```

**クライアント起動:**
```bash
cd client  
npm run dev  # http://localhost:5173
```

## 実装済み機能

### 1. 認証システム

**仕様:**
- ゲストユーザーのみ（登録不要）
- UUID + 表示名で識別
- 同名ユーザー許可（システム内部でUUIDで区別）

**フロー:**
1. プレイヤー名入力
2. 自動的にUUID生成・認証
3. ルーム選択画面に移行

### 2. ルーム管理システム

**ルーム仕様:**
- 6桁数字のルームID（自動生成）
- 最大4人まで参加
- 空になったルームは自動削除

**機能:**
- ルーム作成（作成者は自動参加）
- ルーム参加（IDで検索）
- ルーム退出
- リアルタイム状態同期

### 3. ホストシステム

**ホスト権限:**
- ルーム作成者が初期ホスト
- ホスト退出時は次のプレイヤーが自動昇格
- ゲーム開始権限（ホストのみ）

**UI表示:**
- ホストには青いボーダーと「(ホスト)」表示
- ホスト専用「ゲーム開始」ボタン

### 4. 準備状態管理

**仕様:**
- 各プレイヤーの準備状態を管理
- 「準備完了」「準備中」の切り替え
- 全員準備完了時の通知

### 5. ゲーム開始システム

**開始条件:**
- 4人全員が参加
- 全員が準備完了
- ホストがゲーム開始ボタンをクリック

**バリデーション:**
- 人数不足時のエラー表示
- 準備未完了時のエラー表示
- 非ホストの開始試行防止

## データ構造

### Player（プレイヤー）
```typescript
interface Player {
  userId: string;      // UUID（内部管理用）
  displayName: string; // 表示名（同名OK）
  socketId: string;    // Socket接続ID
  isReady: boolean;    // 準備状態
  isHost: boolean;     // ホスト権限
}
```

### Room（ルーム）
```typescript
interface Room {
  roomId: string;      // 6桁数字ID
  players: Player[];   // プレイヤー配列（最大4人）
  maxPlayers: number;  // 最大人数（固定4）
  createdAt: number;   // 作成時刻
  gameStarted: boolean; // ゲーム開始フラグ
}
```

## Socket.io イベント仕様

### クライアント → サーバー

| イベント名 | パラメータ | 説明 |
|-----------|-----------|------|
| `authenticate` | `{ displayName: string }` | ユーザー認証 |
| `create-room` | なし | ルーム作成 |
| `join-room` | `{ roomId: string }` | ルーム参加 |
| `leave-room` | なし | ルーム退出 |
| `toggle-ready` | なし | 準備状態切り替え |
| `start-game` | なし | ゲーム開始（ホストのみ） |

### サーバー → クライアント

| イベント名 | パラメータ | 説明 |
|-----------|-----------|------|
| `authenticated` | `{ userId: string, displayName: string }` | 認証完了 |
| `room-created` | `{ roomId: string }` | ルーム作成完了 |
| `room-joined` | `{ room: Room }` | ルーム参加完了 |
| `room-left` | なし | ルーム退出完了 |
| `room-update` | `{ room: Room }` | ルーム状態更新 |
| `all-players-ready` | なし | 全員準備完了 |
| `game-started` | `{ room: Room }` | ゲーム開始 |
| `join-error` | `{ message: string }` | エラー通知 |

## UI/UX仕様

### 認証画面
- プレイヤー名入力フィールド
- 「ゲーム開始」ボタン

### ルーム選択画面
- 「新しいルームを作成」セクション
- 「既存のルームに参加」セクション（6桁ID入力）
- エラーメッセージ表示エリア

### ルーム画面
- ルームID表示とヘッダー
- 「ルーム退出」ボタン（右上）
- プレイヤー一覧（座席番号、名前、ホスト表示、準備状態）
- 「準備完了」/「準備解除」ボタン
- ホスト専用「ゲーム開始」ボタン
- ゲーム状態表示

### カラーコーディング
- **通常プレイヤー**: グレーボーダー
- **準備完了プレイヤー**: 緑ボーダー + 薄緑背景
- **ホスト**: 青ボーダー + 薄青背景
- **ホスト準備完了**: 水色ボーダー + 薄水色背景

## エラーハンドリング

### よくあるエラーと対処

| エラーメッセージ | 原因 | 対処 |
|----------------|------|------|
| "ユーザー認証が必要です" | 未認証状態でのアクション | 再認証を促す |
| "ルームが見つかりません" | 無効なルームID | IDの再確認を促す |
| "ルームが満員です" | 4人満員のルーム参加 | 他のルームを案内 |
| "ホストのみがゲームを開始できます" | 非ホストのゲーム開始試行 | ホスト権限の説明 |
| "4人揃ってからゲームを開始してください" | 人数不足でのゲーム開始 | 追加プレイヤー待ちを案内 |
| "全員の準備が完了してからゲームを開始してください" | 準備未完了でのゲーム開始 | 準備完了待ちを案内 |

## 接続・切断処理

### 正常なフロー
1. Socket.io接続確立
2. 認証完了
3. ルーム参加
4. ゲーム開始

### 異常系対応
- **接続断**: 自動再接続（Socket.io標準機能）
- **プレイヤー退出**: ルームから自動削除、他プレイヤーに通知
- **ホスト退出**: 次のプレイヤーが自動昇格
- **ルーム空**: 自動削除

## 今後の拡張予定

### Phase 1: 麻雀ゲームロジック（未実装）
- 牌データ構造の設計
- 手牌・捨て牌管理
- ツモ・切り・ポン・チー・リーチ・ロン
- 和了判定・点数計算

### Phase 2: UI/UX改善
- 牌の3D表示
- ドラッグ&ドロップ操作
- アニメーション効果
- 音響効果

### Phase 3: 追加機能
- 観戦モード
- チャット機能
- リプレイ機能
- カスタムルール設定

## 開発注意事項

### TypeScript関連
- 型インポートは `import type` を使用
- verbatimModuleSyntax対応済み

### Socket.io関連
- 各イベントに適切なエラーハンドリング実装
- リアルタイム状態同期の一貫性確保

### セキュリティ考慮
- UUIDによる内部識別（なりすまし対策）
- ホスト権限の適切な管理
- 入力値のバリデーション

---

**最終更新:** 2025-06-22  
**ステータス:** Phase 1 基盤機能完了、麻雀ロジック未実装